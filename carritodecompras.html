<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito de compras</title>
    <link rel="icon" href="images/logoiconsinfondo.ico" type="image/gif" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    


<style>
    /* ------------------------------------------------------------------- */
    /* GLOBAL & BACKGROUND */
    /* ------------------------------------------------------------------- */
    body { 
        font-family: 'Inter', sans-serif;
        background-color: #f7f7f7; 
        color: #333; 
    }
    
    /* ------------------------------------------------------------------- */
    /* MODAL CONTAINER (Checkout Window) */
    /* ------------------------------------------------------------------- */
    .modal {
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow-y: auto; 
        background-color: rgba(0, 0, 0, 0.7);
        display: flex; 
        justify-content: center;
        align-items: flex-start;
        padding: 20px 10px;
    }
    
    #checkoutModal .modal-content {
        background-color: #ffffff;
        padding: 25px; 
        border-radius: 16px; 
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.35); 
        width: 100%; 
        max-width: 600px;
        display: flex;
        flex-direction: column;
        position: relative;
        margin-top: 25px; 
        margin-bottom: 25px;
    }
    
    /* Ajuste para pantallas grandes */
    @media (min-width: 640px) {
        #checkoutModal .modal-content {
            padding: 40px;
        }
    }
    
    .close-btn { 
        color: #777; 
        position: absolute; 
        top: 15px; 
        right: 20px; 
        font-size: 32px; 
        font-weight: normal; 
        cursor: pointer; 
        transition: color 0.3s ease, transform 0.3s ease; 
    }
    .close-btn:hover { color: #333; transform: rotate(90deg); } 

    /* ------------------------------------------------------------------- */
    /* CHECKOUT STEPS & INDICATORS */
    /* ------------------------------------------------------------------- */
    .step-content { display: none; padding-top: 15px; } 
    .step-content.active { display: block; }
    
    .step-indicator { 
        display: flex; 
        justify-content: space-between; 
        margin-bottom: 25px; 
        gap: 8px; 
    }
    .step-indicator > div { 
        flex: 1; 
        text-align: center; 
        font-weight: 600; 
        color: #a1a1a1; 
        border-bottom: 4px solid #e0e0e0; 
        padding-bottom: 10px; 
        font-size: 0.85rem; 
        transition: all 0.3s ease; 
    }
    .step-indicator > div.active { 
        color: #1e3a8a; 
        border-bottom-color: #1e3a8a; 
    }
    
    /* ------------------------------------------------------------------- */
    /* QR OPTIONS (PAYMENT SELECTION) */
    /* ------------------------------------------------------------------- */
    .qr-option { 
        border: 2px solid #e5e7eb; 
        border-radius: 12px; 
        padding: 18px; 
        margin-bottom: 12px; 
        cursor: pointer; 
        transition: all 0.3s ease; 
        background-color: #ffffff; 
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
    }
    .qr-option:hover {
        border-color: #bae6fd; 
        background-color: #f8faff; 
    }
    .qr-option.selected { 
        border-color: #10b981; 
        background-color: #f0fff8; 
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.15); 
    }

    .producto-glasses, .info-glasses { flex: 1; padding: 0 15px; }
    .slider { overflow: hidden; position: relative; height: 300px; }
    .slide { display: none; }
    .slide.active { display: block; }
</style>

</head>
<body class="p-4 md:p-8">

    <div id="messageBox" class="fixed top-0 left-0 right-0 bg-yellow-100 text-yellow-800 p-3 text-center transition-all duration-300 transform -translate-y-full z-50"></div>
    
    <div id="checkoutModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="closeCheckoutBtn">&times;</span>
            <h2 class="text-2xl font-bold text-gray-800 mb-4" id="checkoutTitle">Tu Carrito de Compras</h2>
            
            <div class="step-indicator">
                <div id="stepIndicator1" class="active">1. Carrito & Direcci√≥n</div>
                <div id="stepIndicator2">2. Env√≠o & Total</div>
                <div id="stepIndicator3">3. Pago & Captura</div>
            </div>

            <div id="step1" class="step-content active">
                <div id="cartSummary" class="overflow-y-auto mb-4 p-2 border rounded-lg"> 
                    <p class="text-gray-500 text-center py-4">El carrito est√° vac√≠o.</p>
                </div>

                <div class="text-right text-xl font-bold mb-4">
                    Subtotal: <span id="subtotalProducts">$0 COP</span>
                </div>
                
                <h3 class="text-lg font-semibold mb-2">Datos de Env√≠o</h3>
                <form id="addressForm" class="space-y-3">
                <input type="text" id="clientName" placeholder="Nombre Completo (Ej: Juan David D√≠az P√©rez)" required class="w-full p-2 border border-gray-300 rounded-lg">
                <input type="text" id="clientPhone" placeholder="Tel√©fono (Ej: 3137549245)" required class="w-full p-2 border border-gray-300 rounded-lg">

                <input type="text" id="clientDepartment" placeholder="Departamento/Estado (Ej: Cundinamarca)" required class="w-full p-2 border border-gray-300 rounded-lg">

                <input type="text" id="clientCity" placeholder="Ciudad (Ej: Bogot√°)" required class="w-full p-2 border border-gray-300 rounded-lg">


                <input type="text" id="clientAddress" placeholder="Direcci√≥n Exacta (Ej: Calle 76D #56-2, Barrio Patio Bonito)" required class="w-full p-2 border border-gray-300 rounded-lg">
                </form>


                <div class="mt-6 flex justify-between">
                    <button id="vaciarCarritoBtn" class="bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition">Vaciar Carrito</button>
                    <button id="nextToStep2" class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition disabled:opacity-50">Continuar al Env√≠o &rarr;</button>
                </div>
            </div>

            <div id="step2" class="step-content">
                
                <div id="shippingQuoteResult" class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <p class="text-lg font-semibold">Calculando...</p>
                </div>

                <div class="space-y-2 p-4 border rounded-lg bg-gray-50">
                    <div class="flex justify-between font-medium">

                    </div>
                    <div class="flex justify-between font-medium">
                        <span>Subtotal de Productos:</span>
                        <span id="displaySubtotal2">$0 COP</span>
                    </div>
                    <div class="flex justify-between font-medium text-green-600">
                        <span>Costo de Env√≠o (Aproximado):</span>
                        <span id="displayShippingCost">$0 COP</span>
                    </div>
                    <div class="border-t pt-2 mt-2 flex justify-between text-2xl font-extrabold text-blue-700">
                        <span>TOTAL A TRANSFERIR:</span>
<span id="displayFinalTotal" class="text-green-600">$0 COP</span>                    </div>
                </div>

                <div class="mt-6 flex justify-between">
                    <button id="backToStep1" class="bg-gray-400 text-white p-3 rounded-lg hover:bg-gray-500 transition">&larr; Regresar</button>
                    <button id="nextToStep3" class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition">Continuar al Pago &rarr;</button>
                </div>
            </div>

            <div id="step3" class="step-content">
                <h3 class="text-xl font-semibold mb-4 text-center">Selecciona tu m√©todo de pago</h3>
                
                <div id="paymentMethodSelection" class="space-y-3">
                    <div class="qr-option" data-method="nequi">
                        <div class="flex items-center justify-between">
                            <span class="font-bold text-pink-600 flex items-center gap-2">Nequi</span>
                            <i data-lucide="check-circle" class="text-green-500 hidden payment-check"></i>
                        </div>
                        <img src="images/nequi.jpg" alt="QR Nequi" class="qr-image mt-2 hidden mx-auto rounded-lg shadow-md">
                    </div>
                    
                    <div class="qr-option" data-method="Daviplata">
                        <div class="flex items-center justify-between">
                            <span class="font-bold text-yellow-600 flex items-center gap-2">Daviplata</span>
                            <i data-lucide="check-circle" class="text-green-500 hidden payment-check"></i>
                        </div>
                        <img src="images/daviplata.jpg" alt="QR Daviplata" class="qr-image mt-2 hidden mx-auto rounded-lg shadow-md">
                    </div>
                </div>

                <div id="paymentUploadSection" class="mt-6 p-4 border border-dashed rounded-lg bg-gray-50 hidden">
                    <p class="font-semibold mb-2">Adjunte comprobante de pago</p>
                    <input type="file" id="paymentScreenshot" accept="image/*" class="w-full p-2 border border-gray-300 rounded-lg bg-white" required>
                    <p class="text-sm text-gray-500 mt-1">Solo formatos .jpg, .png.</p>
                </div>

                <div class="mt-6 flex justify-between">
                    <button id="backToStep2" class="bg-gray-400 text-white p-3 rounded-lg hover:bg-gray-500 transition">&larr; Regresar</button>
                    <button id="confirmOrderBtn" class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition disabled:opacity-50" disabled>Confirmar Orden</button>
                </div>
            </div>
            
<div id="step4" class="step-content text-center hidden"> 
    <i data-lucide="check-circle" class="w-16 h-16 text-green-500 mx-auto mb-4"></i>
    <h3 class="text-2xl font-bold mb-3">¬°Orden Confirmada!</h3>
    <p class="text-gray-700">Tu pedido ha sido registrado con √©xito. Pronto nos pondremos en contacto contigo para coordinar el env√≠o.</p>
    
    <div class="mt-4 p-3 bg-green-50 rounded-lg border border-green-200">
        <p class="text-sm font-semibold">ID de la Orden: <span id="orderIdDisplay" class="font-normal text-gray-600">N/A</span></p>
    </div>
    
    <div class="mt-4 p-3 bg-yellow-100 rounded-lg border border-yellow-300">
        <p class="text-sm font-bold text-yellow-800 flex items-center justify-center">
            <i data-lucide="camera" class="w-5 h-5 mr-2"></i>
            IMPORTANTE: ¬°Toma una captura de pantalla!
        </p>
        <p class="text-xs text-yellow-700 mt-1">Este ID es tu comprobante √∫nico.</p>
    </div>

    <button id="closeAndReturnBtn" class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition mt-6 inline-block">Cerrar y Regresar a la Tienda</button>
</div>


        </div>
    </div>

    <div class="p-8">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-8 text-center">Checkout de la Tienda</h1>
        <p class="text-center text-lg text-gray-600">Esta es la p√°gina de pago. La ventana de tu carrito est√° abierta autom√°ticamente.</p>
    </div>

    <div id="modalRopa1" class="modal" style="display: none;"> <div class="modal-content"><span class="close-btn">&times;</span><div class="producto-glasses"><div class="slider"><div class="slide active"></div></div></div><div class="info-glasses"><h1>Camisa 1.1 Moncler</h1><p id="selectedColorRopa1" style="display: none;"><span id="colorNameRopa1">blanco1</span></p><div class="contador"><button id="restarRopa1">-</button><input type="text" id="cantidadRopa1" value="1" readonly /><button id="sumarRopa1">+</button></div><button class="btn-add-cart" id="agregarCarritoModalRopa1">Agregar</button></div></div>
    



<script type="module">
    import { initFirebase, db as firestoreDb, userId as currentUserId, storage as firebaseStorage } from './js/firebase-init.js';
    
    import { addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js"; 

    let db;
    let userId; 
    let storage; 
    let firebaseInitialized = false; 

    let estadoPedido = { cliente: {}, costoEnvio: 0, subtotal: 0, totalFinal: 0, metodoPago: null, orderId: null };

    // -------------------------------------------------------------------
    // DATOS DE PRODUCTOS (COMPLETOS)
    // -------------------------------------------------------------------
    const modalesCountRelojes = 6;
    const modalesCountRopa = 13; 

    const productData = {
        modalProducto1: { name: 'INVICTA Caballero (Silicona)', type: 'Reloj', options: [{ color: 'Blanco', price: 100000 }, { color: 'Azul', price: 100000 }, { color: 'Negro centro azul', price: 100000 }, { color: 'Negro centro negro', price: 100000 }, { color: 'Negro centro blanco', price: 100000 }] },
        modalProducto2: { name: 'INVICTA Caballero (Pulso en silicona)', type: 'Reloj', options: [{ color: 'Dorado', price: 175000 }, { color: 'Bronce', price: 175000 }] }, 
        modalProducto3: { name: 'INVICTA Caballero', type: 'Reloj', options: [{ color: 'Dorado', price: 185000 }, { color: 'Verde', price: 185000 }, { color: 'Negro', price: 185000 }, { color: 'Azul', price: 185000 }] },      
        modalProducto4: { name: 'Combo Caballero', type: 'Reloj', options: [{ color: 'Negro', price: 65000 }, { color: 'Plateado', price: 65000 }, { color: 'Dorado', price: 65000 }] },
        modalProducto5: { name: 'Pareja Cartier', type: 'Reloj', options: [{ color: 'Plateado Bronce Centro Blanco', price: 120000 }, { color: 'Plateado Dorado Centro Oscuro', price: 120000 }, { color: 'Plateado Centro Blanco', price: 120000 }, { color: 'Plateado Dorado Centro Negro', price: 120000 }, { color: 'Dorado Centro Negro', price: 120000 }, { color: 'Dorado Centro Blanco', price: 120000 }] },
        modalProducto6: { name: 'ROLEX Presidencial', type: 'Reloj', options: [{ color: 'Verde Centro Negro Borde Dorado', price: 110000 }, { color: 'Azul Centro Azul Borde Dorado', price: 110000 }, { color: 'Negro Centro Negro Borde Dorado', price: 110000 }, { color: 'Azul Centro Azul', price: 110000 }, { color: 'Negro Centro Negro', price: 110000 }, { color: 'Verde Centro Verde Borde Dorado', price: 110000 }] },
        modalRopa1: { name: 'Camisa 1.1 Moncler', type: 'Ropa', options: [{ color: 'blanco1', price: 90000 }, { color: 'negro1', price: 90000 }, { color: 'blanco2', price: 90000 }, { color: 'negro2', price: 90000 }, { color: 'blanco3', price: 90000 }, { color: 'negro3', price: 90000 }, { color: 'blanco4', price: 90000 }, { color: 'negro4', price: 90000 }, { color: 'negro5', price: 90000 }, { color: 'blanco5', price: 90000 }, { color: 'azul5', price: 90000 }] },
        modalRopa2: { name: 'Camisa 1.1 Dolce & Gabbana', type: 'Ropa', options: [{ color: 'blanco', price: 90000 }, { color: 'negro', price: 90000 }] },
        modalRopa3: { name: 'Camisa 1.1 Amiri', type: 'Ropa', options: [{ color: 'blanco', price: 90000 }, { color: 'negro', price: 90000 }] },
        modalRopa4: { name: 'Camisa 1.1 Dolce & Gabbana 2', type: 'Ropa', options: [{ color: 'blanco', price: 90000 }, { color: 'negro', price: 90000 }] },
        modalRopa5: { name: 'Camisa Colombia', type: 'Ropa', options: [{ color: 'hombre', price: 90000 }, { color: 'mujer', price: 90000 }] },
        modalRopa6: { name: 'Camisa 1.1 Esencial', type: 'Ropa', options: [{ color: 'azuloscuro', price: 90000 }, { color: 'marronclaro', price: 90000 }, { color: 'azulclaro', price: 90000 }] },
        modalRopa7: { name: 'Camisa 1.1 Amiri 2', type: 'Ropa', options: [{ color: 'blanco', price: 90000 }, { color: 'negro', price: 90000 }] },
        modalRopa8: { name: 'Camisa 1.1 Louis Vuitton', type: 'Ropa', options: [{ color: 'negro1', price: 90000 }, { color: 'blanco1', price: 90000 }, { color: 'blanco2', price: 90000 }, { color: 'negro2', price: 90000 }] },
        modalRopa9: { name: 'Camisa 1.1 Fendi', type: 'Ropa', options: [{ color: 'blanco', price: 90000 }, { color: 'negro', price: 90000 }] },
        modalRopa10: { name: 'Camisa 1.1 Loewe', type: 'Ropa', options: [{ color: 'blanco', price: 90000 }, { color: 'negro', price: 90000 }] },
        modalRopa11: { name: 'Conjunto de Short Importado', type: 'Ropa', options: [{ color: 'negro', price: 85000 }, { color: 'cafe', price: 85000 }, { color: 'blanco', price: 85000 }, { color: 'azuloscuro', price: 85000 }] },
        modalRopa12: { name: 'Conjunto Texturizado Loewe', type: 'Ropa', options: [{ color: 'negro', price: 100000 }, { color: 'blanco', price: 100000 }, { color: 'cafe', price: 100000 }] },
        modalRopa13: { name: 'Conjunto de Jeans Full Brillo', type: 'Ropa', options: [{ color: 'blanco', price: 110000 }, { color: 'oscuro', price: 110000 }] }
    };
    // -------------------------------------------------------------------
    // FIN DATOS DE PRODUCTOS
    // -------------------------------------------------------------------

    const formatCurrency = (amount) => `$${amount.toLocaleString('es-CO')} COP`;

    function showMessage(text, isError = false) {
        const box = document.getElementById('messageBox');
        box.textContent = text;
        box.className = `fixed top-0 left-0 right-0 p-3 text-center transition-all duration-300 transform translate-y-0 z-50 rounded-b-lg ${isError ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`;
        setTimeout(() => { box.classList.add('-translate-y-full'); }, 3000);
    }

    function loadCart() {
        const storedCart = localStorage.getItem('shoppingCart');
        try { return storedCart ? JSON.parse(storedCart) : []; } catch (e) { return []; }
    }

    function saveCart(cart) {
        localStorage.setItem('shoppingCart', JSON.stringify(cart));
        window.dispatchEvent(new Event('storage')); 
    }

    let cartSelections = loadCart();

    function calcularTotalCarrito() {
        return cartSelections.reduce((total, item) => total + item.price * item.quantity, 0);
    }

    const COSTO_ENVIO_FIJO_SIMULADO = 15300; 

    function cotizarEnvioFijo() {
        return { 
            costo: COSTO_ENVIO_FIJO_SIMULADO, 
            descripcion: 'El costo de env√≠o es aproximado y se paga contra entrega.'
        };
    }

    // -------------------------------------------------------------------
    // FUNCI√ìN √öNICA PARA INICIALIZAR Y ASIGNAR LAS VARIABLES DE FIREBASE
    // -------------------------------------------------------------------
    async function initFirebaseAndAssignVars() {
        const isReady = await initFirebase();
        if (isReady) {
            db = firestoreDb;
            userId = currentUserId;
            storage = firebaseStorage;
            firebaseInitialized = true;
            return true;
        }
        return false;
    }

    // -------------------------------------------------------------------
    // FUNCIONES DE FIREBASE Y GUARDADO 
    // -------------------------------------------------------------------

    async function uploadScreenshotAndGetUrl(file) {
        if (!file || !storage) return null; 
        
        const dataUrl = await new Promise((resolve) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.readAsDataURL(file);
        });

        const timestamp = Date.now();
        const appId = 'o-ktrends'; 
        const storageRef = ref(storage, `${appId}/${userId}/screenshots/${timestamp}_${file.name}`);

        await uploadString(storageRef, dataUrl, 'data_url');
        
        return await getDownloadURL(storageRef);
    }
    
    async function guardarPedidoEnFirestore() {
        if (!firebaseInitialized || !db || !userId || !storage) {
            showMessage("Error", true);
            const success = await initFirebaseAndAssignVars(); 
            if (!success) {
                 showMessage("Error", true);
                 return;
            }
        }
        
        try {
            const screenshotFile = document.getElementById('paymentScreenshot').files[0];
            const screenshotUrl = await uploadScreenshotAndGetUrl(screenshotFile); 
            
            const datosPedido = {
                cliente: { ...estadoPedido.cliente },
                productos: cartSelections.map(item => ({ name: item.name, color: item.color, price: item.price, quantity: item.quantity })),
                costoEnvioSimulado: estadoPedido.costoEnvio, 
                subtotal: estadoPedido.subtotal,
                totalATransferir: estadoPedido.totalFinal, 
                metodoPago: estadoPedido.metodoPago,
                paymentScreenshotUrl: screenshotUrl, 
                status: 'PENDIENTE DE REVISI√ìN',
                createdAt: serverTimestamp(),
                userId: userId,
                _appId: 'o-ktrends'
            };

            const collectionPath = `artifacts/o-ktrends/users/${userId}/orders`;
            const docRef = await addDoc(collection(db, collectionPath), datosPedido);
            
            estadoPedido.orderId = docRef.id;
            showMessage(`‚úÖ ¬°Orden registrada! ID: ${docRef.id}`, false);
            document.getElementById('orderIdDisplay').textContent = docRef.id;
            setStep(4);
            
        } catch (e) {
            console.error("Error al guardar la orden");
            showMessage("Error al guardar la orden", true);
            document.getElementById('confirmOrderBtn').disabled = false;
        }
    }


    // -------------------------------------------------------------------
    // L√ìGICA DEL CHECKOUT (Inicializaci√≥n de DOM y Event Listeners)
    // -------------------------------------------------------------------

    const checkoutModal = document.getElementById('checkoutModal');
    const closeCheckoutBtn = document.getElementById('closeCheckoutBtn');
    const cartSummaryDiv = document.getElementById('cartSummary');
    const subtotalProductsSpan = document.getElementById('subtotalProducts');
    const addressForm = document.getElementById('addressForm');
    const vaciarCarritoBtn = document.getElementById('vaciarCarritoBtn');
    const confirmOrderBtn = document.getElementById('confirmOrderBtn');

    let currentStep = 1;

function setStep(step) {
    currentStep = step;
    
    document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
    
    document.querySelectorAll('.step-indicator > div').forEach(el => el.classList.remove('active'));

    const stepContent = document.getElementById(`step${step}`);
    if (stepContent) {
        stepContent.classList.add('active');
    } else {
        console.warn(`[setStep Warning] No se encontr√≥ el contenido para: step${step}`);
    }

    const stepIndicator = document.getElementById(`stepIndicator${step}`);
    if (step < 4 && stepIndicator) {
        stepIndicator.classList.add('active');
    }

    const titles = { 1: 'Tu Carrito y Direcci√≥n', 2: 'Resumen de la Orden y Env√≠o', 3: 'Finalizar Pago', 4: 'Confirmaci√≥n de Pedido' };
    document.getElementById('checkoutTitle').textContent = titles[step] || 'Checkout';

    document.querySelector('.step-indicator').style.display = step < 4 ? 'flex' : 'none';

    if (step === 2) {
        const subtotalElement = document.querySelector('#step2 .font-extrabold > span:first-child');
        if (subtotalElement) {
             subtotalElement.textContent = 'SUBTOTAL A TRANSFERIR';
        }
    }
}

    
    function removeItem(index) {
        const modal = document.getElementById('checkoutModal');
        const tempConfirm = createCustomConfirm('¬øEst√°s seguro de que quieres eliminar este producto del carrito?', () => {
            cartSelections.splice(index, 1); 
            saveCart(cartSelections);
            renderCartSummary();
            showMessage("Producto eliminado del carrito.", false);
            modal.removeChild(tempConfirm);
        }, () => {
            modal.removeChild(tempConfirm);
        });
        modal.appendChild(tempConfirm);
    }
    
    function createCustomConfirm(message, onConfirm, onCancel) {
        const confirmModal = document.createElement('div');
        confirmModal.className = 'fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[110] p-4';
        confirmModal.innerHTML = `
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                <p class="text-lg font-semibold mb-4">${message}</p>
                <div class="flex justify-end space-x-3">
                    <button id="cancelBtn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                    <button id="confirmBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Confirmar</button>
                </div>
            </div>
        `;
        
        confirmModal.querySelector('#confirmBtn').onclick = onConfirm;
        confirmModal.querySelector('#cancelBtn').onclick = onCancel;
        return confirmModal;
    }

    function renderCartSummary() {
        cartSelections = loadCart(); 

        const subtotal = calcularTotalCarrito();
        estadoPedido.subtotal = subtotal; 

        subtotalProductsSpan.textContent = formatCurrency(subtotal);
        document.getElementById('displaySubtotal2').textContent = formatCurrency(subtotal);
        
        if (cartSelections.length === 0) {
            cartSummaryDiv.innerHTML = '<p class="text-red-500 text-center py-4 font-bold">‚ö†Ô∏è ¬°El carrito est√° vac√≠o! Agrega productos desde el cat√°logo.</p>';
            document.getElementById('nextToStep2').disabled = true;
            if (currentStep > 1) setStep(1); 
            return;
        }
        
        document.getElementById('nextToStep2').disabled = false;

        let html = cartSelections.map((item, index) => `
            <div class="flex justify-between items-center p-2 border-b last:border-b-0">
                <div class="flex flex-col">
                    <span class="font-semibold">${item.name}</span>
                    <span class="text-sm text-gray-500">Color: ${item.color} - Cant: ${item.quantity}</span>
                    <span class="text-sm font-bold">${formatCurrency(item.price * item.quantity)}</span>
                </div>
                <button class="remove-item-btn text-red-500 hover:text-red-700 p-1 transition" data-index="${index}" title="Eliminar Producto">
                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                </button>
            </div>
        `).join('');
        
        cartSummaryDiv.innerHTML = html;
        lucide.createIcons(); 

        document.querySelectorAll('.remove-item-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                const index = parseInt(e.currentTarget.dataset.index);
                removeItem(index);
            });
        });
    }

    document.getElementById('nextToStep2').addEventListener('click', () => {
        if (cartSelections.length === 0) { showMessage("El carrito est√° vac√≠o.", true); return; }
        if (!addressForm.checkValidity()) { showMessage("Completa todos los campos de la direcci√≥n.", true); addressForm.reportValidity(); return; }

        estadoPedido.cliente = {
            name: document.getElementById('clientName').value,
            phone: document.getElementById('clientPhone').value,
            department: document.getElementById('clientDepartment').value, 
            city: document.getElementById('clientCity').value,
            address: document.getElementById('clientAddress').value,
        };
        
        const cotizacion = cotizarEnvioFijo();
        const costoEnvio = cotizacion.costo;

        estadoPedido.costoEnvio = costoEnvio;
        estadoPedido.totalFinal = estadoPedido.subtotal; 
        
        document.getElementById('displayShippingCost').textContent = formatCurrency(costoEnvio);
        document.getElementById('displayFinalTotal').textContent = formatCurrency(estadoPedido.totalFinal); 

        document.getElementById('shippingQuoteResult').innerHTML = `
            <p class="text-lg font-bold text-blue-700">Costo de Env√≠o Estimado (Aproximado):</p>
            <p class="text-2xl">${formatCurrency(costoEnvio)}</p>
            <p class="text-sm text-red-600 font-bold mt-2">
                üî¥ ATENCI√ìN: El costo exacto se te notificar√° al momento de despachar.
            </p>
            <p class="text-sm text-green-700 mt-1 font-bold">
                ‚úÖ El valor del env√≠o real <strong>(aproximado a ${formatCurrency(costoEnvio)})</strong> se paga al momento de recibir el producto (contra entrega).
            </p>
        `;

        setStep(2);
    });

    document.getElementById('nextToStep3').addEventListener('click', () => { setStep(3); });
    document.getElementById('backToStep1').addEventListener('click', () => setStep(1));
    document.getElementById('backToStep2').addEventListener('click', () => setStep(2));
    
    document.querySelectorAll('.qr-option').forEach(option => {
    option.addEventListener('click', function() {
        document.querySelectorAll('.qr-option').forEach(opt => {
            opt.classList.remove('selected');
            opt.querySelector('.payment-check').classList.add('hidden');
            opt.querySelector('.qr-image').classList.add('hidden');
        });

        this.classList.add('selected');
        this.querySelector('.payment-check').classList.remove('hidden');
        this.querySelector('.qr-image').classList.remove('hidden');

        document.getElementById('paymentUploadSection').classList.remove('hidden');
        
        estadoPedido.metodoPago = this.dataset.method; 

        const screenshotInput = document.getElementById('paymentScreenshot');
        
        if (firebaseInitialized && screenshotInput.files.length > 0) {
             confirmOrderBtn.disabled = false;
        } else {
             confirmOrderBtn.disabled = true; 
        }
    });
});

    document.getElementById('paymentScreenshot').addEventListener('change', (e) => {
        confirmOrderBtn.disabled = e.target.files.length === 0 || !firebaseInitialized;
    });

    confirmOrderBtn.addEventListener('click', async () => {
        if (!estadoPedido.metodoPago || document.getElementById('paymentScreenshot').files.length === 0) { 
            showMessage("Falta seleccionar m√©todo de pago o subir la captura.", true);
            return;
        }
        
        confirmOrderBtn.disabled = true;
        confirmOrderBtn.textContent = 'Guardando Orden...';
        await guardarPedidoEnFirestore(); 
        confirmOrderBtn.textContent = 'Confirmar Orden';
    });
    
    vaciarCarritoBtn.addEventListener('click', () => {
        const modal = document.getElementById('checkoutModal');
        const tempConfirm = createCustomConfirm('¬øVaciar carrito y volver al cat√°logo?', () => {
            cartSelections = []; 
            saveCart(cartSelections);
            window.history.back(); 
            modal.removeChild(tempConfirm);
        }, () => {
            modal.removeChild(tempConfirm);
        });
        modal.appendChild(tempConfirm);
    });

    closeCheckoutBtn.addEventListener('click', () => { window.history.back(); });
    document.getElementById('closeAndReturnBtn').addEventListener('click', () => { window.history.back(); });

    // -------------------------------------------------------------------
    // PUNTO DE INICIO: Inicializaci√≥n principal
    // -------------------------------------------------------------------
// -------------------------------------------------------------------
// PUNTO DE INICIO: Inicializaci√≥n principal
// -------------------------------------------------------------------
document.addEventListener("DOMContentLoaded", async () => {
    lucide.createIcons();
    
    const screenshotInput = document.getElementById('paymentScreenshot');
    
    if (confirmOrderBtn) confirmOrderBtn.disabled = true;
    
    if (screenshotInput) {
        screenshotInput.disabled = false; 
    }

    const success = await initFirebaseAndAssignVars();

    if (success) {
        if (screenshotInput) {
            screenshotInput.disabled = false; 
            console.log("‚úÖ Input de comprobante habilitado.");
        }
        
        if (confirmOrderBtn) {
            confirmOrderBtn.disabled = screenshotInput.files.length === 0;
        }
        
        showMessage("", false);
    } else {
        showMessage("", true);
    }

    renderCartSummary();
    setStep(1);

    const activeModalColorIndices = {}; 
    for(let i = 1; i <= modalesCountRelojes; i++) { setupModal(`modalProducto${i}`, i, ""); }
    for(let i = 1; i <= modalesCountRopa; i++) { setupModal(`modalRopa${i}`, i, "Ropa"); }
});

    function setupModal(modalId, index, prefix) {
        const modal = document.getElementById(modalId);
        if (!modal) return;
    } 

</script>





</body>
</html>