<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito de compras</title>
    <link rel="icon" href="images/logoiconsinfondo.ico" type="image/gif" />

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Importaciones de Firestore y Storage
        import { getFirestore, doc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadString, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js"; // 💡 Agregado Storage
        
        // Variables Globales Proporcionadas por Canvas (o simuladas)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId, storage; // 💡 Agregado storage

        async function initFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("🔴 ERROR: Firebase config no está disponible. El guardado en DB no funcionará.");
                    return false;
                }
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app); // 💡 Inicializando Storage

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                userId = auth.currentUser?.uid || crypto.randomUUID();
                console.log(`✅ Firebase inicializado. User ID: ${userId}`);

                document.dispatchEvent(new CustomEvent('firebase-ready', { detail: { db, userId } }));
                return true;

            } catch (error) {
                console.error("🔴 ERROR en la inicialización de Firebase:", error);
                return false;
            }
        }

        initFirebase();
    </script>

<style>
    /* ------------------------------------------------------------------- */
    /* GLOBAL & BACKGROUND */
    /* ------------------------------------------------------------------- */
    body { 
        font-family: 'Inter', sans-serif; /* Fuente moderna y legible */
        background-color: #f7f7f7; /* Fondo gris muy claro (más profesional que el amarillo) */
        color: #333; /* Color de texto oscuro para un buen contraste */
    }
    
    /* ------------------------------------------------------------------- */
    /* MODAL CONTAINER (Checkout Window) */
    /* ------------------------------------------------------------------- */
    .modal {
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow-y: auto; 
        background-color: rgba(0, 0, 0, 0.7); /* Fondo más oscuro para enfoque */
        display: flex; 
        justify-content: center;
        align-items: flex-start;
        padding: 20px 10px; /* Más padding vertical, menos horizontal en móviles */
    }
    
    #checkoutModal .modal-content {
        background-color: #ffffff;
        padding: 25px; /* Ligeramente menos padding para móviles */
        border-radius: 16px; /* Bordes más redondeados y modernos */
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.35); /* Sombra más pronunciada y elegante */
        width: 100%; /* Ocupa todo el ancho en móvil */
        max-width: 600px;
        display: flex;
        flex-direction: column;
        position: relative;
        margin-top: 25px; 
        margin-bottom: 25px;
    }
    
    /* Ajuste para pantallas grandes */
    @media (min-width: 640px) {
        #checkoutModal .modal-content {
            padding: 40px;
        }
    }
    
    .close-btn { 
        color: #777; 
        position: absolute; 
        top: 15px; 
        right: 20px; 
        font-size: 32px; /* Más grande */
        font-weight: normal; 
        cursor: pointer; 
        transition: color 0.3s ease, transform 0.3s ease; 
    }
    .close-btn:hover { color: #333; transform: rotate(90deg); } /* Efecto hover moderno */

    /* ------------------------------------------------------------------- */
    /* CHECKOUT STEPS & INDICATORS */
    /* ------------------------------------------------------------------- */
    .step-content { display: none; padding-top: 15px; } 
    .step-content.active { display: block; }
    
    .step-indicator { 
        display: flex; 
        justify-content: space-between; 
        margin-bottom: 25px; 
        gap: 8px; 
    }
    .step-indicator > div { 
        flex: 1; 
        text-align: center; 
        font-weight: 600; 
        color: #a1a1a1; 
        border-bottom: 4px solid #e0e0e0; /* Borde más grueso y claro */
        padding-bottom: 10px; 
        font-size: 0.85rem; /* Fuente más pequeña para que quepa en móvil (RESPONSIVE) */
        transition: all 0.3s ease; 
    }
    .step-indicator > div.active { 
        color: #1e3a8a; /* Azul oscuro elegante */ 
        border-bottom-color: #1e3a8a; 
    }
    
    /* ------------------------------------------------------------------- */
    /* QR OPTIONS (PAYMENT SELECTION) */
    /* ------------------------------------------------------------------- */
    .qr-option { 
        border: 2px solid #e5e7eb; 
        border-radius: 12px; 
        padding: 18px; 
        margin-bottom: 12px; 
        cursor: pointer; 
        transition: all 0.3s ease; 
        background-color: #ffffff; 
        /* Usamos flex para mejor control en el diseño del QR */
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
    }
    .qr-option:hover {
        border-color: #bae6fd; 
        background-color: #f8faff; 
    }
    .qr-option.selected { 
        border-color: #10b981; /* Verde esmeralda para destacar la selección */ 
        background-color: #f0fff8; 
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.15); /* Anillo sutil */
    }

    /* ------------------------------------------------------------------- */
    /* OTRAS REGLAS MANTENIDAS */
    /* ------------------------------------------------------------------- */
    .producto-glasses, .info-glasses { flex: 1; padding: 0 15px; }
    .slider { overflow: hidden; position: relative; height: 300px; }
    .slide { display: none; }
    .slide.active { display: block; }
</style>

</head>
<body class="p-4 md:p-8">

    <div id="messageBox" class="fixed top-0 left-0 right-0 bg-yellow-100 text-yellow-800 p-3 text-center transition-all duration-300 transform -translate-y-full z-50"></div>
    
    <div id="checkoutModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="closeCheckoutBtn">&times;</span>
            <h2 class="text-2xl font-bold text-gray-800 mb-4" id="checkoutTitle">Tu Carrito de Compras</h2>
            
            <div class="step-indicator">
                <div id="stepIndicator1" class="active">1. Carrito & Dirección</div>
                <div id="stepIndicator2">2. Envío & Total</div>
                <div id="stepIndicator3">3. Pago & Captura</div>
            </div>

            <div id="step1" class="step-content active">
                <div id="cartSummary" class="overflow-y-auto mb-4 p-2 border rounded-lg"> 
                    <p class="text-gray-500 text-center py-4">El carrito está vacío.</p>
                </div>

                <div class="text-right text-xl font-bold mb-4">
                    Subtotal: <span id="subtotalProducts">$0 COP</span>
                </div>
                
                <h3 class="text-lg font-semibold mb-2">Datos de Envío</h3>
                <form id="addressForm" class="space-y-3">
                <input type="text" id="clientName" placeholder="Nombre Completo (Ej: Juan David Díaz Pérez)" required class="w-full p-2 border border-gray-300 rounded-lg">
                <input type="text" id="clientPhone" placeholder="Teléfono (Ej: 3137549245)" required class="w-full p-2 border border-gray-300 rounded-lg">

                <!-- Input libre para Departamento -->
                <input type="text" id="clientDepartment" placeholder="Departamento/Estado (Ej: Cundinamarca)" required class="w-full p-2 border border-gray-300 rounded-lg">

                <!-- Input libre para Ciudad -->
                <input type="text" id="clientCity" placeholder="Ciudad (Ej: Bogotá)" required class="w-full p-2 border border-gray-300 rounded-lg">


                <input type="text" id="clientAddress" placeholder="Dirección Exacta (Ej: Calle 76D #56-2, Barrio Patio Bonito)" required class="w-full p-2 border border-gray-300 rounded-lg">
                </form>


                <div class="mt-6 flex justify-between">
                    <button id="vaciarCarritoBtn" class="bg-red-500 text-white p-2 rounded-lg hover:bg-red-600 transition">Vaciar Carrito</button>
                    <button id="nextToStep2" class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition disabled:opacity-50">Continuar al Envío &rarr;</button>
                </div>
            </div>

            <div id="step2" class="step-content">
                
                <div id="shippingQuoteResult" class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <p class="text-lg font-semibold">Calculando...</p>
                </div>

                <div class="space-y-2 p-4 border rounded-lg bg-gray-50">
                    <div class="flex justify-between font-medium">

                    </div>
                    <div class="flex justify-between font-medium">
                        <span>Subtotal de Productos:</span>
                        <span id="displaySubtotal2">$0 COP</span>
                    </div>
                    <div class="flex justify-between font-medium text-green-600">
                        <span>Costo de Envío (Aproximado):</span>
                        <span id="displayShippingCost">$0 COP</span>
                    </div>
                    <div class="border-t pt-2 mt-2 flex justify-between text-2xl font-extrabold text-blue-700">
                        <span>TOTAL A TRANSFERIR:</span>
<span id="displayFinalTotal" class="text-green-600">$0 COP</span>                    </div>
                </div>

                <div class="mt-6 flex justify-between">
                    <button id="backToStep1" class="bg-gray-400 text-white p-3 rounded-lg hover:bg-gray-500 transition">&larr; Regresar</button>
                    <button id="nextToStep3" class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition">Continuar al Pago &rarr;</button>
                </div>
            </div>

            <div id="step3" class="step-content">
                <h3 class="text-xl font-semibold mb-4 text-center">Selecciona tu método de pago</h3>
                
                <div id="paymentMethodSelection" class="space-y-3">
                    <div class="qr-option" data-method="nequi">
                        <div class="flex items-center justify-between">
                            <span class="font-bold text-pink-600 flex items-center gap-2">Nequi</span>
                            <i data-lucide="check-circle" class="text-green-500 hidden payment-check"></i>
                        </div>
                        <img src="images/mono.jpg" alt="QR Nequi" class="qr-image mt-2 hidden mx-auto rounded-lg shadow-md">
                    </div>
                    
                    <div class="qr-option" data-method="bancolombia">
                        <div class="flex items-center justify-between">
                            <span class="font-bold text-yellow-600 flex items-center gap-2">Bancolombia</span>
                            <i data-lucide="check-circle" class="text-green-500 hidden payment-check"></i>
                        </div>
                        <img src="images/mono.jpg" alt="QR Bancolombia" class="qr-image mt-2 hidden mx-auto rounded-lg shadow-md">
                    </div>
                </div>

                <div id="paymentUploadSection" class="mt-6 p-4 border border-dashed rounded-lg bg-gray-50 hidden">
                    <p class="font-semibold mb-2">Adjunte comprobante de pago</p>
                    <input type="file" id="paymentScreenshot" accept="image/*" class="w-full p-2 border border-gray-300 rounded-lg bg-white" required>
                    <p class="text-sm text-gray-500 mt-1">Solo formatos .jpg, .png.</p>
                </div>

                <div class="mt-6 flex justify-between">
                    <button id="backToStep2" class="bg-gray-400 text-white p-3 rounded-lg hover:bg-gray-500 transition">&larr; Regresar</button>
                    <button id="confirmOrderBtn" class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition disabled:opacity-50" disabled>Confirmar Orden</button>
                </div>
            </div>
            
            <div id="confirmationMessage" class="step-content text-center">
                <i data-lucide="check-circle" class="w-16 h-16 text-green-500 mx-auto mb-4"></i>
                <h3 class="text-2xl font-bold mb-3">¡Orden Confirmada!</h3>
                <p class="text-gray-700">Tu pedido ha sido registrado con éxito. Pronto nos pondremos en contacto contigo para coordinar el envío.</p>
                <div class="mt-4 p-3 bg-green-50 rounded-lg border border-green-200">
                    <p class="text-sm font-semibold">ID de la Orden: <span id="orderIdDisplay" class="font-normal text-gray-600">N/A</span></p>
                </div>
                <button id="closeAndReturnBtn" class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition mt-6 inline-block">Cerrar y Regresar a la Tienda</button>
            </div>

        </div>
    </div>

    <div class="p-8">
        <h1 class="text-4xl font-extrabold text-gray-900 mb-8 text-center">Checkout de la Tienda</h1>
        <p class="text-center text-lg text-gray-600">Esta es la página de pago. La ventana de tu carrito está abierta automáticamente.</p>
    </div>

    <div id="modalRopa1" class="modal" style="display: none;"> <div class="modal-content"><span class="close-btn">&times;</span><div class="producto-glasses"><div class="slider"><div class="slide active"></div></div></div><div class="info-glasses"><h1>Camisa 1.1 Moncler</h1><p id="selectedColorRopa1" style="display: none;"><span id="colorNameRopa1">blanco1</span></p><div class="contador"><button id="restarRopa1">-</button><input type="text" id="cantidadRopa1" value="1" readonly /><button id="sumarRopa1">+</button></div><button class="btn-add-cart" id="agregarCarritoModalRopa1">Agregar</button></div></div>
    



    <script>
        document.addEventListener("DOMContentLoaded", () => {
            lucide.createIcons();

            // --- VARIABLES DE ESTADO Y CONFIGURACIÓN ---
            const modalesCountRelojes = 6;
            const modalesCountRopa = 13; 
            let db, userId, storage;

            // 💡 TRADUCCIÓN: orderState a estadoPedido
            let estadoPedido = { cliente: {}, costoEnvio: 0, subtotal: 0, totalFinal: 0, metodoPago: null, orderId: null };

            // 🟢 ESTRUCTURA PRINCIPAL: Datos de TODOS los productos (Mantenidos)
            const productData = {
                modalProducto1: { name: 'INVICTA Caballero (Silicona)', type: 'Reloj', options: [{ color: 'Blanco', price: 100000 }, { color: 'Azul', price: 100000 }, { color: 'Negro centro azul', price: 100000 }, { color: 'Negro centro negro', price: 100000 }, { color: 'Negro centro blanco', price: 100000 }] },
                modalProducto2: { name: 'INVICTA Caballero (Pulso en silicona)', type: 'Reloj', options: [{ color: 'Dorado', price: 175000 }, { color: 'Bronce', price: 175000 }] }, 
                modalProducto3: { name: 'INVICTA Caballero', type: 'Reloj', options: [{ color: 'Dorado', price: 185000 }, { color: 'Verde', price: 185000 }, { color: 'Negro', price: 185000 }, { color: 'Azul', price: 185000 }] },        
                modalProducto4: { name: 'Combo Caballero', type: 'Reloj', options: [{ color: 'Negro', price: 65000 }, { color: 'Plateado', price: 65000 }, { color: 'Dorado', price: 65000 }] },
                modalProducto5: { name: 'Pareja Cartier', type: 'Reloj', options: [{ color: 'Plateado Bronce Centro Blanco', price: 120000 }, { color: 'Plateado Dorado Centro Oscuro', price: 120000 }, { color: 'Plateado Centro Blanco', price: 120000 }, { color: 'Plateado Dorado Centro Negro', price: 120000 }, { color: 'Dorado Centro Negro', price: 120000 }, { color: 'Dorado Centro Blanco', price: 120000 }] },
                modalProducto6: { name: 'ROLEX Presidencial', type: 'Reloj', options: [{ color: 'Verde Centro Negro Borde Dorado', price: 110000 }, { color: 'Azul Centro Azul Borde Dorado', price: 110000 }, { color: 'Negro Centro Negro Borde Dorado', price: 110000 }, { color: 'Azul Centro Azul', price: 110000 }, { color: 'Negro Centro Negro', price: 110000 }, { color: 'Verde Centro Verde Borde Dorado', price: 110000 }] },
                modalRopa1: { name: 'Camisa 1.1 Moncler', type: 'Ropa', options: [{ color: 'blanco1', price: 90000 }, { color: 'negro1', price: 90000 }, { color: 'blanco2', price: 90000 }, { color: 'negro2', price: 90000 }, { color: 'blanco3', price: 90000 }, { color: 'negro3', price: 90000 }, { color: 'blanco4', price: 90000 }, { color: 'negro4', price: 90000 }, { color: 'negro5', price: 90000 }, { color: 'blanco5', price: 90000 }, { color: 'azul5', price: 90000 }] },
                modalRopa2: { name: 'Camisa 1.1 Dolce & Gabbana', type: 'Ropa', options: [{ color: 'blanco', price: 90000 }, { color: 'negro', price: 90000 }] },
                modalRopa3: { name: 'Camisa 1.1 Amiri', type: 'Ropa', options: [{ color: 'blanco', price: 90000 }, { color: 'negro', price: 90000 }] },
                modalRopa4: { name: 'Camisa 1.1 Dolce & Gabbana 2', type: 'Ropa', options: [{ color: 'blanco', price: 90000 }, { color: 'negro', price: 90000 }] },
                modalRopa5: { name: 'Camisa Colombia', type: 'Ropa', options: [{ color: 'hombre', price: 90000 }, { color: 'mujer', price: 90000 }] },
                modalRopa6: { name: 'Camisa 1.1 Esencial', type: 'Ropa', options: [{ color: 'azuloscuro', price: 90000 }, { color: 'marronclaro', price: 90000 }, { color: 'azulclaro', price: 90000 }] },
                modalRopa7: { name: 'Camisa 1.1 Amiri 2', type: 'Ropa', options: [{ color: 'blanco', price: 90000 }, { color: 'negro', price: 90000 }] },
                modalRopa8: { name: 'Camisa 1.1 Louis Vuitton', type: 'Ropa', options: [{ color: 'negro1', price: 90000 }, { color: 'blanco1', price: 90000 }, { color: 'blanco2', price: 90000 }, { color: 'negro2', price: 90000 }] },
                modalRopa9: { name: 'Camisa 1.1 Fendi', type: 'Ropa', options: [{ color: 'blanco', price: 90000 }, { color: 'negro', price: 90000 }] },
                modalRopa10: { name: 'Camisa 1.1 Loewe', type: 'Ropa', options: [{ color: 'blanco', price: 90000 }, { color: 'negro', price: 90000 }] },
                modalRopa11: { name: 'Conjunto de Short Importado', type: 'Ropa', options: [{ color: 'negro', price: 85000 }, { color: 'cafe', price: 85000 }, { color: 'blanco', price: 85000 }, { color: 'azuloscuro', price: 85000 }] },
                modalRopa12: { name: 'Conjunto Texturizado Loewe', type: 'Ropa', options: [{ color: 'negro', price: 100000 }, { color: 'blanco', price: 100000 }, { color: 'cafe', price: 100000 }] },
                modalRopa13: { name: 'Conjunto de Jeans Full Brillo', type: 'Ropa', options: [{ color: 'blanco', price: 110000 }, { color: 'oscuro', price: 110000 }] }
            };

            // =================================================================
            // 💡 FUNCIONES DE UTILIDAD (ALERTAS Y PERSISTENCIA)
            // =================================================================
            const formatCurrency = (amount) => `$${amount.toLocaleString('es-CO')} COP`;

            function showMessage(text, isError = false) {
                const box = document.getElementById('messageBox');
                box.textContent = text;
                box.className = `fixed top-0 left-0 right-0 p-3 text-center transition-all duration-300 transform translate-y-0 z-50 rounded-b-lg ${isError ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800'}`;
                setTimeout(() => { box.classList.add('-translate-y-full'); }, 3000);
            }

            function loadCart() {
                const storedCart = localStorage.getItem('shoppingCart');
                try { return storedCart ? JSON.parse(storedCart) : []; } catch (e) { return []; }
            }

            function saveCart(cart) {
                localStorage.setItem('shoppingCart', JSON.stringify(cart));
                window.dispatchEvent(new Event('storage')); 
            }

            let cartSelections = loadCart();

            function calcularTotalCarrito() {
                return cartSelections.reduce((total, item) => total + item.price * item.quantity, 0);
            }

            // =================================================================
            // 📦 LÓGICA DE COTIZACIÓN DE ENVÍO (FIJA)
            // =================================================================
            
            // 💡 Costo de envío fijo simulado de $15.300 COP
            const COSTO_ENVIO_FIJO_SIMULADO = 15300; 

            // 💡 Lógica de cotización fija
            function cotizarEnvioFijo() {
                return { 
                    costo: COSTO_ENVIO_FIJO_SIMULADO, 
                    descripcion: 'El costo de envío es aproximado y se paga contra entrega.'
                };
            }


            // =================================================================
            // 📦 LÓGICA DE FIREBASE Y DATA (MODIFICADA PARA USAR STORAGE)
            // =================================================================

            async function uploadScreenshotAndGetUrl(file) {
                if (!file || !storage) return null;
                
                const dataUrl = await new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result);
                    reader.readAsDataURL(file);
                });

                const timestamp = Date.now();
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const storageRef = ref(storage, `${appId}/${userId}/screenshots/${timestamp}_${file.name}`);

                await uploadString(storageRef, dataUrl, 'data_url');
                
                return await getDownloadURL(storageRef);
            }
            
            async function guardarPedidoEnFirestore() {
                if (!db || !userId || !storage) {
                    showMessage("Error: Conexión a la base de datos no lista. Intenta de nuevo.", true);
                    return;
                }
                
                try {
                    const screenshotFile = document.getElementById('paymentScreenshot').files[0];
                    const screenshotUrl = await uploadScreenshotAndGetUrl(screenshotFile); 
                    
                    const datosPedido = {
                        cliente: { ...estadoPedido.cliente },
                        productos: cartSelections.map(item => ({
                            name: item.name, color: item.color, price: item.price, quantity: item.quantity
                        })),
                        costoEnvioSimulado: estadoPedido.costoEnvio, // Se almacena el costo simulado del envío
                        subtotal: estadoPedido.subtotal,
                        // El totalFinal en 'estadoPedido' ya NO incluye el envío (solo subtotal)
                        totalATransferir: estadoPedido.totalFinal, 
                        metodoPago: estadoPedido.metodoPago,
                        
                        paymentScreenshotUrl: screenshotUrl, 
                        status: 'PENDIENTE DE REVISIÓN',
                        createdAt: serverTimestamp(),
                        userId: userId,
                        _appId: typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'
                    };

                    const collectionPath = `artifacts/${appId}/users/${userId}/orders`;

                    const docRef = await addDoc(collection(db, collectionPath), datosPedido);
                    
                    estadoPedido.orderId = docRef.id;
                    showMessage(`✅ ¡Orden registrada! ID: ${docRef.id}`, false);
                    document.getElementById('orderIdDisplay').textContent = docRef.id;

                    setStep(4);
                    
                } catch (e) {
                    console.error("🔴 Error al guardar la orden en Firestore:", e);
                    showMessage("Error al guardar la orden: " + e.message, true);
                    document.getElementById('confirmOrderBtn').disabled = false;
                }
            }


            // =================================================================
            // 🛒 LÓGICA DEL CHECKOUT MODAL 
            // =================================================================

            const checkoutModal = document.getElementById('checkoutModal');
            const closeCheckoutBtn = document.getElementById('closeCheckoutBtn');
            const cartSummaryDiv = document.getElementById('cartSummary');
            const subtotalProductsSpan = document.getElementById('subtotalProducts');
            const addressForm = document.getElementById('addressForm');
            const vaciarCarritoBtn = document.getElementById('vaciarCarritoBtn');
            const confirmOrderBtn = document.getElementById('confirmOrderBtn');

            let currentStep = 1;

            function setStep(step) {
                currentStep = step;
                document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.step-indicator > div').forEach(el => el.classList.remove('active'));

                document.getElementById(`step${step}`).classList.add('active');
                if (step < 4) document.getElementById(`stepIndicator${step}`).classList.add('active');
                
                const titles = { 1: 'Tu Carrito y Dirección', 2: 'Resumen de la Orden y Envío', 3: 'Finalizar Pago', 4: 'Confirmación de Pedido' };
                document.getElementById('checkoutTitle').textContent = titles[step] || 'Checkout';

                document.querySelector('.step-indicator').style.display = step < 4 ? 'flex' : 'none';

                // Si estamos en el paso 2, actualizamos el texto del total
                if (step === 2) {
                     // 💡 Se cambia el nombre del label del total a transferir
                    document.querySelector('#step2 .font-extrabold > span:first-child').textContent = 'SUBTOTAL A TRANSFERIR';
                }
            }
            
            function removeItem(index) {
                const modal = document.getElementById('checkoutModal');
                const tempConfirm = createCustomConfirm('¿Estás seguro de que quieres eliminar este producto del carrito?', () => {
                    cartSelections.splice(index, 1); 
                    saveCart(cartSelections);
                    renderCartSummary();
                    showMessage("Producto eliminado del carrito.", false);
                    modal.removeChild(tempConfirm);
                }, () => {
                    modal.removeChild(tempConfirm);
                });
                modal.appendChild(tempConfirm);
            }
            
            function createCustomConfirm(message, onConfirm, onCancel) {
                const confirmModal = document.createElement('div');
                confirmModal.className = 'fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-[110] p-4';
                confirmModal.innerHTML = `
                    <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full">
                        <p class="text-lg font-semibold mb-4">${message}</p>
                        <div class="flex justify-end space-x-3">
                            <button id="cancelBtn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Cancelar</button>
                            <button id="confirmBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Confirmar</button>
                        </div>
                    </div>
                `;
                
                confirmModal.querySelector('#confirmBtn').onclick = onConfirm;
                confirmModal.querySelector('#cancelBtn').onclick = onCancel;
                return confirmModal;
            }

            function renderCartSummary() {
                cartSelections = loadCart(); 

                const subtotal = calcularTotalCarrito();
                estadoPedido.subtotal = subtotal; 

                subtotalProductsSpan.textContent = formatCurrency(subtotal);
                document.getElementById('displaySubtotal2').textContent = formatCurrency(subtotal);
                
                if (cartSelections.length === 0) {
                    cartSummaryDiv.innerHTML = '<p class="text-red-500 text-center py-4 font-bold">⚠️ ¡El carrito está vacío! Agrega productos desde el catálogo.</p>';
                    document.getElementById('nextToStep2').disabled = true;
                    if (currentStep > 1) setStep(1); 
                    return;
                }
                
                document.getElementById('nextToStep2').disabled = false;

                let html = cartSelections.map((item, index) => `
                    <div class="flex justify-between items-center p-2 border-b last:border-b-0">
                        <div class="flex flex-col">
                            <span class="font-semibold">${item.name}</span>
                            <span class="text-sm text-gray-500">Color: ${item.color} - Cant: ${item.quantity}</span>
                            <span class="text-sm font-bold">${formatCurrency(item.price * item.quantity)}</span>
                        </div>
                        <button class="remove-item-btn text-red-500 hover:text-red-700 p-1 transition" data-index="${index}" title="Eliminar Producto">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                `).join('');
                
                cartSummaryDiv.innerHTML = html;
                lucide.createIcons(); 

                document.querySelectorAll('.remove-item-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const index = parseInt(e.currentTarget.dataset.index);
                        removeItem(index);
                    });
                });
            }

            // --- LISTENERS DE PASOS ---
            document.getElementById('nextToStep2').addEventListener('click', () => {
                if (cartSelections.length === 0) { showMessage("El carrito está vacío.", true); return; }
                if (!addressForm.checkValidity()) { showMessage("Completa todos los campos de la dirección.", true); addressForm.reportValidity(); return; }

                // Lectura de los datos del cliente
                estadoPedido.cliente = {
                    name: document.getElementById('clientName').value,
                    phone: document.getElementById('clientPhone').value,
                    department: document.getElementById('clientDepartment').value, 
                    city: document.getElementById('clientCity').value,
                    address: document.getElementById('clientAddress').value,
                };
                
                // Cálculo de la cotización fija
                const cotizacion = cotizarEnvioFijo();
                const costoEnvio = cotizacion.costo;

                estadoPedido.costoEnvio = costoEnvio;
                // 💡 CAMBIO: El total final es ahora SÓLO el subtotal de productos
                estadoPedido.totalFinal = estadoPedido.subtotal; 
                
                document.getElementById('displayShippingCost').textContent = formatCurrency(costoEnvio);
                document.getElementById('displayFinalTotal').textContent = formatCurrency(estadoPedido.totalFinal); // Muestra sólo el Subtotal

                document.getElementById('shippingQuoteResult').innerHTML = `
                    <p class="text-lg font-bold text-blue-700">Costo de Envío Estimado (Aproximado):</p>
                    <p class="text-2xl">${formatCurrency(costoEnvio)}</p>
                    <p class="text-sm text-red-600 font-bold mt-2">
                        🔴 ATENCIÓN: El costo exacto se te notificará al momento de despachar.
                    </p>
                    <p class="text-sm text-green-700 mt-1 font-bold">
                        ✅ El valor del envío real <strong>(aproximado a ${formatCurrency(costoEnvio)})</strong> se paga al momento de recibir el producto (contra entrega).
                    </p>
                `;

                setStep(2);
            });

            document.getElementById('nextToStep3').addEventListener('click', () => { setStep(3); });
            document.getElementById('backToStep1').addEventListener('click', () => setStep(1));
            document.getElementById('backToStep2').addEventListener('click', () => setStep(2));
            
            // =================================================================
            // ✅ LÓGICA DE SELECCIÓN DE PAGO Y QR 
            // =================================================================

            document.querySelectorAll('.qr-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.qr-option').forEach(opt => {
                        opt.classList.remove('selected');
                        opt.querySelector('.payment-check').classList.add('hidden');
                        opt.querySelector('.qr-image').classList.add('hidden');
                    });

                    this.classList.add('selected');
                    this.querySelector('.payment-check').classList.remove('hidden');
                    this.querySelector('.qr-image').classList.remove('hidden');

                    document.getElementById('paymentUploadSection').classList.remove('hidden');
                    
                    estadoPedido.metodoPago = this.dataset.method; 

                    const screenshotInput = document.getElementById('paymentScreenshot');
                    confirmOrderBtn.disabled = screenshotInput.files.length === 0;
                });
            });


            document.getElementById('paymentScreenshot').addEventListener('change', (e) => {
                confirmOrderBtn.disabled = e.target.files.length === 0;
            });

            confirmOrderBtn.addEventListener('click', async () => {
                if (!estadoPedido.metodoPago || document.getElementById('paymentScreenshot').files.length === 0) { 
                    showMessage("Falta seleccionar método de pago o subir la captura.", true);
                    return;
                }
                
                confirmOrderBtn.disabled = true;
                confirmOrderBtn.textContent = 'Guardando Orden...';
                await guardarPedidoEnFirestore(); 
                confirmOrderBtn.textContent = 'Confirmar Orden';
            });
            
            // Vaciar y reiniciar (Mantenido)
            vaciarCarritoBtn.addEventListener('click', () => {
                 const modal = document.getElementById('checkoutModal');
                 const tempConfirm = createCustomConfirm('¿Vaciar carrito y volver al catálogo?', () => {
                    cartSelections = []; 
                    saveCart(cartSelections);
                    window.history.back(); 
                    modal.removeChild(tempConfirm);
                }, () => {
                    modal.removeChild(tempConfirm);
                });
                modal.appendChild(tempConfirm);
            });

            // Cerrar Modal y Volver
            closeCheckoutBtn.addEventListener('click', () => { 
                window.history.back(); 
            });

            // Botón de Regresar en la confirmación
            document.getElementById('closeAndReturnBtn').addEventListener('click', () => { 
                window.history.back(); 
            });

            // Carga inicial
            renderCartSummary();
            setStep(1);

            // =================================================================
            // 🚨 LÓGICA DE MODALES DE PRODUCTO (Mantenida)
            // =================================================================
            const activeModalColorIndices = {}; 
            for(let i = 1; i <= modalesCountRelojes; i++) { setupModal(`modalProducto${i}`, i, ""); }
            for(let i = 1; i <= modalesCountRopa; i++) { setupModal(`modalRopa${i}`, i, "Ropa"); }

            function setupModal(modalId, index, prefix) {
                const modal = document.getElementById(modalId);
                if (!modal) return;
                activeModalColorIndices[modalId] = 0;
            } 
        });
    </script>






</body>
</html>